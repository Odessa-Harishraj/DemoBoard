@using JiraClone.Data
@model List<WorkItem>

@{
    Layout = "_Layout";

    var projects = ViewBag.Projects as List<Project> ?? new();
    var boards = ViewBag.Boards as List<Board> ?? new();
    var statuses = ViewBag.Statuses as List<StatusConfig> ?? new();
    var itemValues = ViewBag.ItemValues as List<string> ?? new();
    var devValues = ViewBag.DevValues as List<string> ?? new();
    var baValues = ViewBag.BAValues as List<string> ?? new();
    var typeValues = ViewBag.TypeValues as List<string> ?? new();
    var demoDateValues = ViewBag.DemoDateValues as List<string> ?? new();

    int? selectedProjectId = ViewData["SelectedProjectId"] as int?;
    int? selectedBoardId = ViewData["SelectedBoardId"] as int?;

    // Multi-select selected values
    var selectedStatuses = ViewBag.SelectedStatuses as List<string> ?? new();
    var selectedItems = ViewBag.SelectedItems as List<string> ?? new();
    var selectedDevs = ViewBag.SelectedDevs as List<string> ?? new();
    var selectedBAs = ViewBag.SelectedBAs as List<string> ?? new();
    var selectedTypes = ViewBag.SelectedTypes as List<string> ?? new();
    var selectedDemoDates = ViewBag.SelectedDemoDates as List<string> ?? new();
}

@section Styles {
    <link rel="stylesheet" href="~/css/workitems.css" />
}
<div class="status-list-page">
        <h2>Work Items</h2>

        <a asp-action="Create" class="create-workitem">Create Work Item</a>

        <!-- Search Filter -->
        <form id="workitemsFilterForm" method="get">
            <div class="workitems-filter">

                <div class="filter-group">
                    <label>Project</label>
                    <select name="projectId" id="projectSelect" class="form-control">
                        <option value="">All Projects</option>
                        @foreach (var p in projects)
                        {
                            <option value="@p.Id"
                                    selected="@(selectedProjectId == p.Id)">
                                @p.Name
                            </option>
                        }
                    </select>
                </div>


                <div class="filter-group">
                    <label>Board</label>
                    <select name="boardId" id="boardSelect" class="form-control">
                        <option value="">All Boards</option>
                        @foreach (var b in boards)
                        {
                            <option value="@b.Id"
                                    selected="@(selectedBoardId == b.Id)">
                                @b.Name
                            </option>
                        }
                    </select>
                </div>


                <div class="filter-group" data-filter="status">
                    <label>Status</label>
                    <div class="filter-trigger" data-target="statusPanel">
                        <span class="label">Filter by Status</span>
                        <span class="icon"></span>
                    </div>
                    <div id="statusPanel" class="filter-panel">
                        <div class="panel-header">
                            <input type="text" placeholder="Search..." data-filter-input="statuses" />
                        </div>
                        <div id="statusCheckboxes" class="panel-body">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    <script>
        const filterForm = document.getElementById('workitemsFilterForm');
        const projectSelect = document.getElementById('projectSelect');
        const boardSelect = document.getElementById('boardSelect');
        const selectedBoardId = '@selectedBoardId';

        // Toggle panels
        document.querySelectorAll('.filter-trigger').forEach(trigger => {
            trigger.addEventListener('click', () => {
                const targetId = trigger.getAttribute('data-target');
                const panel = document.getElementById(targetId);
                const isOpen = panel.classList.contains('open');
                // close any open panels
                document.querySelectorAll('.filter-panel.open').forEach(p => p.classList.remove('open'));
                if (!isOpen) panel.classList.add('open');
            });
        });
        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-group')) {
                document.querySelectorAll('.filter-panel.open').forEach(p => p.classList.remove('open'));
            }
        });

        // Search within panels
        document.querySelectorAll('[data-filter-input]').forEach(input => {
            input.addEventListener('input', () => {
                const name = input.getAttribute('data-filter-input');
                const container = document.getElementById(name.replace(/s$/,'') + 'Checkboxes') || document.getElementById(name + 'Checkboxes');
                const term = input.value.toLowerCase();
                container.querySelectorAll('label').forEach(l => {
                    const text = l.querySelector('span').textContent.toLowerCase();
                    l.style.display = text.includes(term) ? '' : 'none';
                });
            });
        });

        // Clear buttons
        document.querySelectorAll('[data-clear]').forEach(btn => {
            btn.addEventListener('click', () => {
                const name = btn.getAttribute('data-clear');
                const container = document.getElementById(name.replace(/s$/,'') + 'Checkboxes') || document.getElementById(name + 'Checkboxes');
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });
        });
        // Apply buttons
        document.querySelectorAll('[data-apply]').forEach(btn => btn.addEventListener('click', () => filterForm.requestSubmit()));

        let submitTimer = null;
        let isUpdatingBoards = false;
        function scheduleSubmit() {
            if (isUpdatingBoards) return; // don't submit while boards are updating
            if (submitTimer) clearTimeout(submitTimer);
            submitTimer = setTimeout(() => {
                filterForm.requestSubmit();
                submitTimer = null;
            }, 200);
        }

        function loadBoards(projectId, submitAfter = true) {
            isUpdatingBoards = true;
            boardSelect.innerHTML = '<option value="">All Boards</option>';

            if (!projectId) {
                isUpdatingBoards = false;
                if (submitAfter) scheduleSubmit();
                return;
            }

            fetch(`/WorkItems/GetBoardsByProject?projectId=${projectId}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b.id;
                        opt.text = b.name;
                        if (b.id == selectedBoardId) {
                            opt.selected = true;
                        }
                        boardSelect.add(opt);
                    });
                })
                .finally(() => {
                    isUpdatingBoards = false;
                    if (submitAfter) scheduleSubmit();
                });
        }

        // Initial load: populate boards only (no submit)
        if (projectSelect.value) {
            loadBoards(projectSelect.value, false);
        }

        // Change project → reload boards and submit once
        projectSelect.addEventListener('change', function () {
            loadBoards(this.value, true);
        });
    </script>
</div>